# intro

This is a small node.js prototype project that defines a simple component (`App.initialize()` in `predtimechart.js`) that uses an [https://ajv.js.org/](Ajv)-based validation module, for ultimate use in https://github.com/reichlab/predtimechart/ .

Goals:

- get [Ajv](https://ajv.js.org/) working in a stand-alone node.js project
- get a Qunit test of a simple user module working ""
- make `document`, `$`, and `Plotly` global variables available to tests
- package/bundle this project into a dependency-free single file for use in a matching small client project - see `ajv-play-client`: just `index.html` and `predtimechart.bundle.js`


# Project structure
```
README.md
package.json
webpack.config.cjs
dist/
  index.html
  predtimechart.bundle.js
src/
  index.html
  predtimechart.css
  predtimechart.js
  schema.json
  schema-validator.cjs
  styles.js
  validation.js
test/
  validation.js
```


**package.json**: defines an [ES6](https://developer.mozilla.org/en-US/docs/Web/JavaScript) project
- `"type": "module"`
- loads: ajv, jquery, jsdom, qunit, and webpack w/its related libs
  - recall https://nodejs.org/api/packages.html :
    > A package.json "type" value of "module" tells Node.js to interpret .js files within that package as using ES module syntax.
    > Within a "type": "module" package, Node.js can be instructed to interpret a particular file as CommonJS by naming it with a .cjs extension (since both .js and .mjs files are treated as ES modules within a "module" package).

**webpack.config.cjs**: configures [webpack](https://webpack.js.org/). took a lot to get it correct, including:
- injecting css into the bundle
- including `output.library.type`
- `entry` order is crucial, and I never figured out why. but putting styles.js last causes the bundled file to not export `App` ("Uncaught SyntaxError: ambiguous indirect export: default")
- ...

**dist/**: destination of bundles files:
- `index.html`: copied by HtmlWebpackPlugin from `src/`. open this file in a browser (served by IntelliJ, say) to see the final app in action
- `predtimechart.bundle.js`: generated by webpack, starting with `webpack.config.cjs`'s `entry`

**src/index.html**: a template that demos using predtimechart.bundle.js`:
- gives us something to run in this project :-) (open `dist/index.html` above)
- uses `htmlWebpackPlugin` as a template variable
- I wasn't able to find solid docs on lodash templates, but these were helpful:
    - http://underscorejs.org/#template
    - https://dustinpfister.github.io/2019/04/05/lodash_template/

**src/predtimechart.css**: the component's styles:
- 'style-loader'/'css-loader' inject styles into the rendered HTML's HEAD by `predtimechart.bundle.js`
-  found via `styles.js`'s importing of this css file

**src/predtimechart.js**: the actual component:
- meant to be used by a client HTML file - see `src/index.html` as an example
- imports `_validateOptions()` from `validation.js`
- defines `App.initialize()` as the entry point
- exports default `App`. NB: this does not work without `webpack.config.cjs`'s `output.library` being set

**src/schema.json**: the play JSON Schema file:
- complied by Ajv cli into `src/schema-validator.cjs` (see)

**src/schema-validator.cjs**: cli-generated standalone validation function as documented [here](https://ajv.js.org/standalone.html):
- NB: this is a [CommonJS module](https://nodejs.org/api/modules.html)
- you must run `build` after generating this file

**src/styles.js**: imports `src/predtimechart.css`
- I separated out from `src/predtimechart.js` so that tests work. (Webpack wants you to import css files into a .js file so that it can discover the dependency for injection into `predtimechart.bundle.js`. However, `import './predtimechart.css';` is invalid JavaScript, so the tests fail. By making it external, it's not used by `src/predtimechart.js` so tests run OK, but it's listed in `webpack.config.cjs`'s `entry` so it's included in the bundle.)

**src/validation.js**: exports `_validateOptions()`:
- uses the [Ajv](https://ajv.js.org/) [JSON Schema](https://json-schema.org/) validation package to validate its input against a toy schema

**test/validation.js**: uses Qunit to test `src/validation.js`:
- NB: since the component under test is browser-based, it requires a Node.js [HTML DOM](https://www.w3.org/TR/WD-DOM/introduction.html) implementation in the testing environment. We use the [jsdom](https://www.npmjs.com/package/jsdom) package for this, but it requires some code to make the `document` global available to the component via tests
- similarly, the component uses [JQuery](https://jquery.com/) and so the `$` global must be available as well
- here's the code to expose those two globals (this took some work to figure out):
```javascript
  import {JSDOM} from "jsdom";
  import jQueryFactory from 'jquery'; // per https://bugs.jquery.com/ticket/14549
  const html = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Title</title></head><body><div id="qunit-fixture"></div></body></html>';
  const jsdomWindow = new JSDOM(html).window;
  global.document = jsdomWindow.document;
  global.$ = jQueryFactory(jsdomWindow);
```


# running tests

NB: Because the unit tests require Node.js packages, QUnit's [In the Browser](https://qunitjs.com/intro/#in-the-browser) feature doesn't work. Instead it must be run via [In Node.js](https://qunitjs.com/intro/#in-nodejs):

```bash
/usr/local/bin/npm test  # runs package.json's `scripts.test` - qunit
```

# packaging/bundling into dist/

```bash
/usr/local/bin/npm build  # runs package.json's `scripts.build` - webpack
```
